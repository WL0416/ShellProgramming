#!/bin/bash

PASSWORDS='./pw'
GUESSFILE='./guess'
DICTIONARY='/usr/share/dict/american-english'
#DICTIONARY='~/e/linux.words'

# Loading users' data first
load()
{
	echo "Loading data"
	sleep 1
	index=0
	while read p
	do
		employees[$index]="$p"
		index=`expr $index + 1`
	done <"$PASSWORDS"
}

# Guess
guess()
{
	echo 'Start audit'
	echo Guess Mode
	sleep 1
	index=0
	while read guess
	do
		guesshash=$(echo -n "$guess" | sha256sum | awk '{print $1}')
		for user in ${employees[@]}
		do
			username=$(echo $user | cut -d":" -f1)
			pwhash=$(echo $user | cut -d":" -f2)
			if [ "$guesshash" == "$pwhash" ]
			then
				employees=("${employees[@]/$user}")
				results[$index]="$username"
				index=`expr $index + 1`
				results[$index]="$guess"
				index=`expr $index + 1`
				found
			fi
		done
	done <"$GUESSFILE" 
}

# Dictionary Attack
dictionary()
{
	echo Dictionary Attack
	sleep 1
	while read guess
	do
		guesshash=$(echo -n "$guess" | sha256sum | awk '{print $1}')
		for user in ${employees[@]}
		do
			username=$(echo $user | cut -d":" -f1)
			pwhash=$(echo $user | cut -d":" -f2)
			if [ "$guesshash" == "$pwhash" ]
			then
				employees=("${employees[@]/$user}")
				results[$index]="$username"
				index=`expr $index + 1`
				results[$index]="$guess"
				index=`expr $index + 1`
				found
			fi
		done
	done <"$DICTIONARY"
}

# Brute Force
brute()
{
	echo Brute Force
	sleep 1
	guessarray=($(echo {a..z} {a..z}{a..z} {a..z}{a..z}{a..z} {a..z}{a..z}{a..z}{a..z}))

	start=`date +%s`
	for guess in ${guessarray[@]}
	do
		if [ ${#employees[@]} -eq 0 ]
		then
			echo all users have been found
			break
		fi
		
		guesshash=$(echo -n "$guess" | sha256sum | awk '{print $1}')

		for user in ${employees[@]}
		do
			username=$(echo $user | cut -d":" -f1)
			pwhash=$(echo $user | cut -d":" -f2)

			if [ "$guesshash" == "$pwhash" ]
			then
				employees=("${employees[@]/$user}")
				results[$index]="$username"
				index=`expr $index + 1`
				results[$index]="$guess"
				index=`expr $index + 1`
				found
			fi
		done

		end=`date +%s`
		runtime=$((end-start))
		echo "$runtime"

		if [ $runtime -eq 120 ]
		then
			echo Time is up.
			break
		fi
	done
}

# Print out the result
found() 
{
	echo "Here is the found users' passwords:"
	rindex=0
	for result in ${results[@]}
	do
		printf "$result"
		rindex=`expr $rindex + 1`
		check=`expr $rindex % 2`
		if [ $check -eq 0 ];then
			printf "\n"
		elif [ $check -eq 1 ];then
			printf " "
		fi
	done
	sleep 1
}

load
printf "\n"
#guess
#printf "\n"
#dictionary
#printf "\n"
brute


